{% extends "base.html" %}

{% block title %}Admin ‚Äì Bemanding{% endblock %}
{% block body_class %}admin-wide{% endblock %}

{% block extra_head %}
<style>
  .page-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
  .page-title{margin:0;}
  .subtitle{color:var(--text-muted);margin-top:4px;}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  .btn-small{padding:7px 12px;font-size:13px;}

  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:4px 10px;border-radius:999px;font-size:12px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.04);
    white-space:nowrap;
  }
  .pill.ok{border-color:rgba(48,199,135,0.35);background:rgba(48,199,135,0.10);}
  .pill.warn{border-color:rgba(255,213,105,0.35);background:rgba(255,213,105,0.10);}
  .pill.bad{border-color:rgba(255,75,75,0.35);background:rgba(255,75,75,0.10);}

  .table-wrap{
    overflow:auto;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(0,0,0,0.15);
  }

  table{width:100%;border-collapse:collapse;min-width:1100px;}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:14px;vertical-align:top;}
  th{
    position:sticky;
    top:0;
    z-index:3;
    background:rgba(25,25,25,0.97);
    color:var(--text-muted);
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.08em;
    white-space:nowrap;
  }
  tr:hover td{background:rgba(255,255,255,0.03);}

  .names-col{min-width:520px;}
  .muted{color:var(--text-muted);}
  .small{font-size:12px;}
  .nowrap{white-space:nowrap;}
  .right{display:flex;justify-content:flex-end;}

  .name-list{margin:0;padding-left:18px;}
  .name-list li{margin:4px 0;}
  .name-line{display:flex;gap:8px;flex-wrap:wrap;align-items:baseline;}

  .tag-mini{
    display:inline-flex;align-items:center;gap:6px;
    padding:2px 8px;border-radius:999px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.04);
    font-size:11px;
    white-space:nowrap;
  }
  .tag-mini.ok{border-color:rgba(48,199,135,0.35);background:rgba(48,199,135,0.10);}
  .tag-mini.warn{border-color:rgba(255,213,105,0.35);background:rgba(255,213,105,0.10);}
  .tag-mini.bad{border-color:rgba(255,75,75,0.35);background:rgba(255,75,75,0.10);}

  /* Bonus: sticky f√∏rste kolonne (dato) */
  .sticky-col{
    position:sticky;
    left:0;
    z-index:2;
    background:rgba(15,15,15,0.97);
    box-shadow: 10px 0 18px rgba(0,0,0,0.25);
  }
  thead .sticky-col{
    z-index:4;
    background:rgba(25,25,25,0.97);
  }

  /* Admin note styling */
  .admin-note{
    margin-top:8px;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(255,213,105,0.22);
    background:rgba(255,213,105,0.08);
    color: rgba(255,255,255,0.92);
  }

  /* =========================
     MOBIL FIX (kun sm√• sk√¶rme)
     Desktop forbliver identisk
     ========================= */
  @media (max-width: 900px){
    /* Top: knapper p√¶nt p√• mobil */
    .btn-row{width:100%;}
    .btn-row a{flex:1 1 auto;justify-content:center;}

    /* Tabel: hellere scroll end wrap-lasagne */
    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
    table{min-width:980px;} /* lidt mindre end 1100, men stadig l√¶sbart */

    th,td{
      white-space:nowrap;
      word-break:normal;
    }

    /* Sticky first col kan f√∏les som en bug p√• telefon -> sl√• fra p√• mobil */
    .sticky-col{
      position: static;
      left: auto;
      z-index: auto;
      background: transparent;
      box-shadow: none;
    }
    thead .sticky-col{
      position: sticky; /* header m√• stadig v√¶re sticky */
      top: 0;
      z-index: 3;
      background: rgba(25,25,25,0.97);
    }

    /* Navne-kolonne m√• ikke dominere hele scrollet */
    .names-col{min-width:420px;}

    /* G√∏r status-tags lidt mindre p√• mobil */
    .tag-mini{font-size:10.5px;padding:2px 7px;}
    .pill{font-size:11px;padding:4px 9px;}
  }

  @media (max-width: 600px){
    /* Lidt mere luft s√• det ikke f√∏les presset */
    th,td{padding:9px;}
    .name-list{padding-left:16px;}
    .admin-note{padding:8px 9px;}
  }
</style>
{% endblock %}

{% block content %}

<div class="card">
  <div class="page-top">
    <div>
      <h1 class="page-title">Bemanding</h1>
      <div class="subtitle">Klik ‚Äú√Öbn‚Äù for m√∏detid / godkend / afvis / fri</div>
    </div>

    <div class="btn-row">
      <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">‚Üê Tilbage</a>
      <a href="{{ url_for('admin_actions') }}" class="btn btn-secondary">Indbakke</a>
    </div>
  </div>
</div>

<div class="card" style="margin-top:14px;">
  {% if not overview %}
    <p class="muted">Ingen kommende arrangementer.</p>
  {% else %}
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="sticky-col">Dato</th>
            <th>Start</th>
            <th>Sted</th>
            <th>Beskrivelse</th>
            <th class="nowrap">Behov</th>
            <th class="nowrap">Godkendte</th>
            <th class="names-col">Navne p√• tilmeldte</th>
            <th class="right">Handling</th>
          </tr>
        </thead>
        <tbody>
          {% for item in overview %}
            {% set shift = item.shift %}
            {% set need = shift.needed %}
            {% set appr = item.counts.approved if item.counts else (item.approved_signups|length) %}
            {% set remaining = need - appr %}

            <tr>
              <td class="nowrap sticky-col">{{ shift.date|dkdate }}</td>
              <td class="nowrap">{{ shift.time }}</td>
              <td>{{ shift.location }}</td>

              <td>
                <strong>{{ shift.description or "Vagt" }}</strong>

                {% if shift.customer or shift.event_type %}
                  <div class="small muted" style="margin-top:4px;">
                    {% if shift.customer %}{{ shift.customer }}{% endif %}
                    {% if shift.customer and shift.event_type %} ¬∑ {% endif %}
                    {% if shift.event_type %}{{ shift.event_type }}{% endif %}
                  </div>
                {% endif %}

                {% if shift.admin_note %}
                  <div class="admin-note small">
                    <strong>Note:</strong> {{ shift.admin_note }}
                  </div>
                {% endif %}
              </td>

              <td class="nowrap">{{ need }}</td>

              <td class="nowrap">
                {% if appr >= need %}
                  <span class="pill ok">‚úÖ {{ appr }}</span>
                {% elif appr > 0 %}
                  <span class="pill warn">‚ö†Ô∏è {{ appr }}</span>
                {% else %}
                  <span class="pill bad">‚õî 0</span>
                {% endif %}
              </td>

              <td>
                {% if item.signups and item.signups|length > 0 %}
                  <ul class="name-list">
                    {% for s in item.signups %}
                      <li>
                        <div class="name-line">
                          {% if s.status == "APPROVED" %}
                            <span class="tag-mini ok">‚úÖ Godkendt</span>
                          {% elif s.status == "REQUESTED" %}
                            <span class="tag-mini warn">‚è≥ Afventer</span>
                          {% elif s.status == "RELEASE_REQUESTED" %}
                            <span class="tag-mini bad">üö™ √ònsker fri</span>
                          {% else %}
                            <span class="tag-mini">{{ s.status }}</span>
                          {% endif %}

                          <strong>{{ s.name }}</strong>
                          <span class="muted">({{ s.phone }})</span>

                          {% if s.meet_time %}
                            <span class="muted">‚Äì m√∏der {{ s.meet_time }}</span>
                          {% endif %}

                          {# Availability: fra/til/range #}
                          {% if s.available_from and s.available_until %}
                            <span class="muted">‚Äì kan {{ s.available_from }}‚Äì{{ s.available_until }}</span>
                          {% elif s.available_from %}
                            <span class="muted">‚Äì kan fra {{ s.available_from }}</span>
                          {% elif s.available_until %}
                            <span class="muted">‚Äì kan til {{ s.available_until }}</span>
                          {% endif %}

                          {# Freelancer note (valgfri, hvis du sender den med) #}
                          {% if s.freelancer_note %}
                            <span class="muted">‚Äì note: ‚Äú{{ s.freelancer_note }}‚Äù</span>
                          {% endif %}
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <span class="muted"><em>Ingen tilmeldte endnu</em></span>
                {% endif %}

                <div style="margin-top:8px;">
                  {% if remaining > 0 %}
                    <span class="pill warn">Mangler {{ remaining }}</span>
                  {% else %}
                    <span class="pill ok">D√¶kket</span>
                  {% endif %}
                </div>
              </td>

              <td class="right nowrap">
                <!-- ‚úÖ RET: link skal g√• til GET-formen, ikke POST-route -->
                <a href="{{ url_for('admin_edit_shift_form', shift_id=shift.id) }}" class="btn btn-primary btn-small">√Öbn</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>

{% endblock %}
