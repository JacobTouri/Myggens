{% extends "base.html" %}

{% block title %}Eventkalender â€“ Myggen's{% endblock %}

{% block content %}
<div class="layout-two-column">
  <!-- Main -->
  <section class="card card-soft">
    <div class="card-header">
      <div>
        <h1 style="margin:0;">Eventkalender</h1>
        <div class="card-subtitle">Tryk pÃ¥ et event for at melde dig til.</div>
      </div>

      <!-- âœ… NYT: Mogens-knap -->
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <a href="{{ url_for('vagtoversigt_mogens') }}" class="btn btn-secondary">ðŸ“Š Mogensknappen </a>
      </div>
    </div>

    <div class="shift-list" style="margin-top:12px;">
      {% for shift in shifts %}
        {% set approved_count = shift.approved or 0 %}
        {% set remaining = shift.needed - approved_count %}

        <!-- Kort -->
        <div class="card"
             style="margin-top:12px;"
             data-shift-id="{{ shift.id }}"
             data-cancel-base="{{ url_for('freelancer_frameld', signup_id=0) }}">

          <!-- Top row: dato/tid/loc + badge + fremeld-slot -->
          <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:700; font-size:16px;">{{ shift.date|dkdate }}</div>
              <div class="helper-text">Kl. {{ shift.time }} â€“ {{ shift.location }}</div>
            </div>

            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
              {% if remaining > 0 %}
                <div class="tag-pill">MANGLER {{ remaining }}</div>
              {% else %}
                <div class="tag-pill" style="border-color: rgba(58,203,106,0.6); background: rgba(58,203,106,0.12); color:#9ff2b7;">
                  HOLDET ER FYLDT
                </div>
              {% endif %}

              <!-- JS indsÃ¦tter evt. fremeld-knap her -->
              <div class="cancel-slot"></div>
            </div>
          </div>

          <!-- Titel/tekst -->
          <div style="margin-top:10px;">
            <div style="font-weight:700; font-size:18px;">
              {{ shift.description or "Vagt" }}
            </div>

            <!-- Admin note (synlig pÃ¥ eventkalenderen) -->
            {% if shift.admin_note and shift.admin_note|trim %}
              <div style="
                margin-top:8px;
                padding:8px 10px;
                border-radius:12px;
                border:1px solid rgba(255,213,105,0.22);
                background:rgba(255,213,105,0.08);
                color: rgba(255,255,255,0.92);
              ">
                <div class="helper-text" style="margin:0; opacity:0.95;">
                  <strong>Note:</strong> {{ shift.admin_note }}
                </div>
              </div>
            {% endif %}

            <!-- Statuslinje: JS kan overskrive denne -->
            {% if remaining > 0 %}
              <div class="shift-status-text" style="margin-top:8px; opacity:0.9;">
                Mangler: {{ remaining }} person(er)
              </div>
            {% else %}
              <div class="shift-status-text" style="margin-top:8px; opacity:0.9;">
                Holdet er fyldt âœ…
              </div>
            {% endif %}
          </div>

          <!-- Actions -->
          <div class="signup-area" style="margin-top:12px;">
            {% if remaining > 0 %}
              <form method="get" action="{{ url_for('tilmeld', shift_id=shift.id) }}" style="margin:0;">
                <button type="submit" class="btn btn-primary">Meld dig pÃ¥</button>
              </form>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </section>

  <!-- Right panel -->
  <aside class="hero-panel">
    <div class="hero-bg-rotator"></div>
    <div class="hero-panel-inner">
      <div>
        <div class="hero-heading">SÃ¥dan fungerer vagterne</div>
        <p class="hero-text" style="margin-top:10px;">
          1. Find en vagt der passer dig.<br>
          2. Meld dig pÃ¥.<br>
          3. Martin godkender dig.<br>
          4. Se dine vagter og log dine timer under <em>Mine vagter</em>.
        </p>
      </div>
    </div>
  </aside>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let phone = null;
  try { phone = localStorage.getItem("myggen_phone"); } catch (e) {}
  if (!phone) return;

  fetch("/api/signups-for-phone?phone=" + encodeURIComponent(phone))
    .then(r => r.json())
    .then(data => {
      if (!data || !Array.isArray(data.signups)) return;

      const byShift = {};
      data.signups.forEach(s => {
        byShift[String(s.shift_id)] = { status: s.status, signup_id: s.signup_id };
      });

      document.querySelectorAll("[data-shift-id]").forEach(card => {
        const shiftId = card.getAttribute("data-shift-id");
        const entry = byShift[String(shiftId)];
        if (!entry) return;

        const status = entry.status;
        const signupId = entry.signup_id;

        const statusText = card.querySelector(".shift-status-text");
        const signupArea = card.querySelector(".signup-area");
        const cancelSlot = card.querySelector(".cancel-slot");

        const cancelBase = card.getAttribute("data-cancel-base") || "";

        function buildCancelUrl(base, id) {
          if (!base) return "";
          return base.replace(/0$/, String(id));
        }

        if (status === "REQUESTED" || status === "APPROVED" || status === "RELEASE_REQUESTED") {
          if (signupArea) signupArea.innerHTML = "";
        }

        if (status === "REQUESTED") {
          if (statusText) statusText.textContent = "Du er tilmeldt â€“ afventer godkendelse fra Martin.";
          if (cancelSlot && signupId) {
            const cancelUrl = buildCancelUrl(cancelBase, signupId);
            cancelSlot.innerHTML = `
              <form method="post"
                    action="${cancelUrl}"
                    onsubmit="return confirm('Er du sikker pÃ¥ at du vil fremelde dig denne vagt?');"
                    style="margin:0;">
                <button type="submit" class="btn btn-danger" style="padding:10px 14px; border-radius:14px;">
                  Fremeld
                </button>
              </form>
            `;
          }
        } else if (status === "APPROVED") {
          if (statusText) statusText.textContent = "Du er sat pÃ¥ denne vagt.";
          if (cancelSlot) cancelSlot.innerHTML = "";
        } else if (status === "RELEASE_REQUESTED") {
          if (statusText) statusText.textContent = "Du er pÃ¥ vagten, men har bedt om fri.";
          if (cancelSlot) cancelSlot.innerHTML = "";
        }
      });
    })
    .catch(() => {});
});
</script>
{% endblock %}
