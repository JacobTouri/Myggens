{% extends "base.html" %}

{% block title %}Timeoversigt ‚Äì Myggen's{% endblock %}
{% block body_class %}admin-wide{% endblock %}

{% block extra_head %}
<style>
  .page-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
  .page-title{margin:0;}
  .subtitle{color:var(--text-muted);margin-top:4px;}

  .pill{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);white-space:nowrap;}
  .pill.ok{border-color:rgba(48,199,135,0.35);background:rgba(48,199,135,0.10);}
  .pill.warn{border-color:rgba(255,213,105,0.35);background:rgba(255,213,105,0.10);}
  .pill.bad{border-color:rgba(255,75,75,0.35);background:rgba(255,75,75,0.10);}

  .btn-small{padding:7px 12px;font-size:13px;}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}

  .form-row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
  .form-field{min-width:160px;flex:1;}
  .form-field select{width:100%;}

  .table-wrap{overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,0.10);background:rgba(0,0,0,0.15);}
  table{width:100%;border-collapse:collapse;min-width:0;table-layout:auto;}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:14px;white-space:normal;word-break:break-word;vertical-align:top;}
  th{position:sticky;top:0;z-index:1;background:rgba(25,25,25,0.95);color:var(--text-muted);font-size:12px;text-transform:uppercase;letter-spacing:0.08em;}
  tr:hover td{background:rgba(255,255,255,0.03);}

  .nowrap{white-space:nowrap;}
  .cell-right{text-align:right;}

  .person-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
  .person-name{margin:0;font-size:18px;font-weight:700;letter-spacing:-0.01em;}
  .person-sub{margin-top:4px;color:var(--text-muted);font-size:13px;}

  .summary-row{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px;}
  .tag-pill-strong{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.04);
    font-weight:800;
  }

  /* Ny: ‚Äúsuccess‚Äù knap (lys gr√∏n) */
  .btn-success{
    border:1px solid rgba(48,199,135,0.55);
    background: rgba(48,199,135,0.18);
    color: #b7f7cf;
  }
  .btn-success:hover{
    filter: brightness(1.05);
  }

  /* Ny: footer under personens tabel */
  .person-total-footer{
    display:flex;
    justify-content:flex-end;
    margin-top:10px;
  }
</style>
{% endblock %}

{% block content %}

<div class="card">
  <div class="page-top">
    <div>
      <h1 class="page-title">Timeoversigt (l√∏n)</h1>
      <div class="subtitle">
        Godkend timer f√∏r afregning ‚Äì freelancerens input er forslag
      </div>
    </div>

    <div class="btn-row">
      <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">‚Üê Tilbage</a>
      <a href="{{ url_for('admin_history') }}" class="btn btn-secondary">Historik</a>
    </div>
  </div>

  <hr style="border:none;border-top:1px solid rgba(255,255,255,0.10);margin:14px 0;">

  <form method="get">
    <div class="form-row">
      <div class="form-field">
        <label for="year">√Ör</label>
        <select name="year" id="year">
          {% for y in years %}
            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-field">
        <label for="month">M√•ned</label>
        <select name="month" id="month">
          {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-field" style="min-width:260px;flex:2;">
        <label style="display:flex;align-items:center;gap:10px;margin-top:24px;">
          <input type="checkbox" name="show_paid" value="1" {% if show_paid %}checked{% endif %}>
          Vis ogs√• allerede afregnede
        </label>
      </div>

      <div style="min-width:160px;">
        <button type="submit" class="btn btn-primary">Opdater</button>
      </div>
    </div>
  </form>

  <div class="summary-row">
    <div class="helper-text">
      Periode: {{ "%02d"|format(month) }}/{{ year }}
    </div>
    <div class="tag-pill-strong">
      Total (alle): {{ "%.2f"|format(grand_total or 0) }} timer
    </div>
  </div>
</div>

{% if not people %}
  <div class="card">
    <h2>Ingen r√¶kker i perioden</h2>
  </div>
{% else %}

{% for person in people %}
  <div class="card" style="margin-top:14px;">
    <div class="person-header">
      <div>
        <h2 class="person-name">{{ person.name }}</h2>
        <div class="person-sub">{{ person.phone }}</div>
      </div>
    </div>

    <div class="table-wrap" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Dato</th>
            <th>Sted</th>
            <th>Beskrivelse</th>
            <th>Start</th>
            <th>Slut</th>
            <th class="cell-right">Timer</th>
            <th>Status</th>
            <th>Handling</th>
          </tr>
        </thead>
        <tbody>

        {% for r in person.rows %}
          {% set missing = (r.work_hours is none) %}
          {% set approved = r.hours_approved_by_admin %}
          {% set final_hours = r.approved_work_hours if approved else r.work_hours %}

          <tr>
            <td>{{ r.shift_date|dkdate }}</td>
            <td>{{ r.location or "-" }}</td>
            <td>{{ r.description }}</td>
            <td>{{ r.work_start or "-" }}</td>
            <td>{{ r.work_end or "-" }}</td>

            <td class="cell-right">
              {% if missing %}
                ‚Äî
              {% else %}
                {{ "%.2f"|format(final_hours) }}
              {% endif %}
            </td>

            <td>
              {% if missing %}
                <span class="pill bad">‚õî Timer mangler</span>
              {% elif not approved %}
                <span class="pill warn">üïí Ikke godkendt</span>
              {% elif r.payroll_paid %}
                <span class="pill ok">‚úÖ Afregnet</span>
              {% else %}
                <span class="pill ok">‚úîÔ∏è Godkendt</span>
              {% endif %}
            </td>

            <td class="nowrap">
              {% if missing %}
                <span class="helper-text">
                  Bed freelanceren registrere timer.
                </span>

              {% elif not approved %}
                <form method="post"
                      action="{{ url_for('admin_timer_approve', signup_id=r.signup_id) }}"
                      class="btn-row"
                      style="margin:0;">
                  <input type="number"
                         name="approved_work_hours"
                         value="{{ "%.2f"|format(r.work_hours) }}"
                         min="0"
                         max="24"
                         step="0.25"
                         style="width:90px;">
                  <button class="btn btn-primary btn-small">
                    Godkend
                  </button>
                </form>

              {% else %}
                {% if not r.payroll_paid %}
                  <form method="post"
                        action="{{ url_for('admin_timer_mark_paid', signup_id=r.signup_id) }}"
                        class="btn-row"
                        style="margin:0;">
                    <input type="hidden" name="paid" value="1">
                    <button class="btn btn-success btn-small">
                      Marker afregnet
                    </button>
                  </form>
                {% else %}
                  <span class="pill ok">Afregnet</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>

        {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Ny: personsummen nederst til h√∏jre -->
    <div class="person-total-footer">
      <div class="tag-pill-strong">
        I alt ({{ person.name }}): {{ "%.2f"|format(person.total_hours or 0) }} timer
      </div>
    </div>

  </div>
{% endfor %}

{% endif %}
{% endblock %}
